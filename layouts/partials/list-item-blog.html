{{ $isFeatured := .IsHome }}
{{ $page := .ctx }}
{{ $authorName := default "rausr" (or $page.Params.author $page.Params.Author) }}
{{ $authorPhoto := default "/images/authors-pic-jakub.jpg" (or $page.Params.author_image $page.Params.authorImage) }}
{{ $bioLink := "" }}
{{ if eq (lower $authorName) "jakub" }}
  {{ $bioLink = "/about/jakub-capliar/" }}
{{ end }}

{{ $lowerTags := apply $page.Params.tags "lower" "." }}
{{ $hasSeries := gt (len (intersect $lowerTags (slice "series"))) 0 }}

{{/* Compute a stable index that continues across pages */}}
{{ $index := .index | default 0 }}
{{ $p := .paginator | default nil }}
{{ $total := 0 }}
{{ if $p }}
  {{ $total = $p.TotalNumberOfElements }}
  {{ $index = add (mul (sub $p.PageNumber 1) $p.PageSize) $index }}
{{ else }}
  {{/* Fallback: compute global index by sorting all blog posts desc and finding this page */}}
  {{ $allBlog := sort (where $page.Site.RegularPages "Section" "blog") "Date" "desc" }}
  {{ $total = len $allBlog }}
  {{ $found := -1 }}
  {{ range $i, $pg := $allBlog }}
    {{ if eq $pg.RelPermalink $page.RelPermalink }}
      {{ $found = $i }}
    {{ end }}
  {{ end }}
  {{ if ge $found 0 }}
    {{ $index = $found }}
  {{ end }}
{{ end }}
{{/* Show oldest article as #1, newest as the highest number */}}
{{ $displayNumber := add $index 1 }}
{{ if gt $total 0 }}
  {{ $displayNumber = sub $total $index }}
{{ end }}

{{ $page.Scratch.Set "link" $page.RelPermalink }}
{{ with $page.Params.link }} {{ $page.Scratch.Set "link" . }} {{ end }}

{{ $page.Date.Format ($page.Site.Params.dateFormat | default "January 2, 2016") | $page.Scratch.Set "subtitle" }}
{{ with $page.Description }} {{ $page.Scratch.Set "subtitle" . }} {{ end }}

{{ $link := $page.Scratch.Get "link" }}

{{ if $isFeatured }}

  <div class="card30">
    <div class="card-badges">
      <span class="card-number">{{ $displayNumber }}</span>
      {{ if $hasSeries }}<span class="card-number card-badge-series" title="Series">✨</span>{{ end }}
    </div>
      <a href="{{ $link }}" class="">
          {{ with $page.Params.preview_image }}
          <div class="card30-top-wrap">
              <div class="card30-top">
                  {{ partial "components/responsive-image.html" (dict
                    "src" .
                    "alt" $page.Title
                    "width" 760
                    "sizes" "(max-width: 991px) 100vw, 760px"
                  ) }}
              </div>
          </div>
          {{ end }}
      </a>
      <div class="card20-text">
          {{ with index $page.Params.tags 0 }}
          <span class="card20-category">
              <a href="{{ "/topics/" | relLangURL }}{{ . | urlize }}">{{ . }}</a>
          </span>
          {{ end }}
          <h3><a href="{{ $link }}">{{ $page.Title }}</a></h3>
          <div class="card20-meta card20-meta--author">
            <span class="card20-meta__date">{{ $page.Date.Format "02.01.2006" }}</span>
            {{ if $bioLink }}
              <a class="card20-meta__author-link" href="{{ $bioLink }}" aria-label="About {{ $authorName }}">
                <span class="card20-meta__author">BY {{ $authorName }}</span>
              </a>
            {{ else }}
              <span class="card20-meta__author">BY {{ $authorName }}</span>
            {{ end }}
            {{ with $authorPhoto }}
              {{ if $bioLink }}
                <a class="card20-meta__photo-link" href="{{ $bioLink }}" aria-label="About {{ $authorName }}">
                  <img class="card20-meta__photo" src="{{ . }}" alt="Portrait of {{ $authorName }}" loading="lazy" decoding="async">
                </a>
              {{ else }}
                <img class="card20-meta__photo" src="{{ . }}" alt="Portrait of {{ $authorName }}" loading="lazy" decoding="async">
              {{ end }}
            {{ end }}
          </div>
      </div>
  </div>

{{ else }}
<div class="card20">
  <div class="card-badges">
    <span class="card-number">{{ $displayNumber }}</span>
    {{ if $hasSeries }}<span class="card-number card-badge-series" title="Series">✨</span>{{ end }}
  </div>
  <a href="{{ $link }}" class="">
      {{ with $page.Params.preview_image }}
      <div class="card20-top">
          {{ partial "components/responsive-image.html" (dict
            "src" .
            "alt" $page.Title
            "width" 170
            "sizes" "(max-width: 991px) 45vw, 170px"
          ) }}
      </div>
      {{ end }}
  </a>
  <div class="card20-text">
      {{ with index $page.Params.tags 0 }}
      <span class="card20-category">
          <a href="{{ "/topics/" | relLangURL }}{{ . | urlize }}">{{ . }}</a>
      </span>
      {{ end }}
      <h3><a href="{{ $link }}">{{ $page.Title }}</a></h3>
      <div class="card20-meta card20-meta--author">
        <span class="card20-meta__date">{{ $page.Date.Format "02.01.2006" }}</span>
        {{ if $bioLink }}
          <a class="card20-meta__author-link" href="{{ $bioLink }}" aria-label="About {{ $authorName }}">
            <span class="card20-meta__author">BY {{ $authorName }}</span>
          </a>
        {{ else }}
          <span class="card20-meta__author">BY {{ $authorName }}</span>
        {{ end }}
        {{ with $authorPhoto }}
          {{ if $bioLink }}
            <a class="card20-meta__photo-link" href="{{ $bioLink }}" aria-label="About {{ $authorName }}">
              <img class="card20-meta__photo" src="{{ . }}" alt="Portrait of {{ $authorName }}" loading="lazy" decoding="async">
            </a>
          {{ else }}
            <img class="card20-meta__photo" src="{{ . }}" alt="Portrait of {{ $authorName }}" loading="lazy" decoding="async">
          {{ end }}
        {{ end }}
      </div>
  </div>
</div>
{{ end }}
