{{ partial "header" . }}
<main>
  <section class="header header-search">
    <div class="header-content">
      <div class="h1container">
        <h1 id="search-title">Search</h1>
        <div class="counter">
          <span class="word">total</span>
          <div class="number total" id="search-total">0</div>
        </div>
      </div>
      <div class="search-controls">
        <div class="search-filters">
          <label><input type="radio" name="section" value="all" checked> All</label>
          <label><input type="radio" name="section" value="works"> Works</label>
          <label><input type="radio" name="section" value="blog"> Articles</label>
        </div>
      </div>
    </div>
  </section>

  <section class="card-container">
    <div id="search-results" class="card-container search-card-container" role="list" aria-label="Search results"></div>
  </section>
</main>

{{ partial "featured-content.html" . }}

{{ partial "cta-contact" . }}

{{ partial "footer" . }}

<!-- Fuse.js (lightweight fuzzy search) -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
(function() {
  const resultsEl = document.getElementById('search-results');
  const filterRadios = document.querySelectorAll('input[name="section"]');
  const titleEl = document.getElementById('search-title');
  const totalEl = document.getElementById('search-total');

  let fuse, data = [], sectionFilter = 'all', currentQuery = '';

  const htmlEscape = (value) => String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  function render(results) {
    resultsEl.innerHTML = '';
    const showMessage = (message) => {
      const empty = document.createElement('div');
      empty.className = 'search-empty';
      empty.setAttribute('role', 'status');
      empty.textContent = message;
      resultsEl.appendChild(empty);
    };
    if (!currentQuery) {
      if (titleEl) titleEl.textContent = 'Search';
      if (totalEl) {
        totalEl.textContent = '0';
        totalEl.setAttribute('aria-label', '0 results shown');
      }
      showMessage('Start your search from the navigation bar to see results here.');
      return;
    }
    if (titleEl) titleEl.textContent = currentQuery;
    if (totalEl) {
      totalEl.textContent = String(results.length);
      totalEl.setAttribute('aria-label', `${results.length} result${results.length===1?'':'s'} shown`);
    }
    if (!results.length) {
      showMessage(`No results for "${currentQuery}"`);
      return;
    }
    const frag = document.createDocumentFragment();
    results.forEach(r => {
      const item = r.item || r; // Fuse returns {item, score}; fallback if not searched yet
      const isWork = item.section === 'works';
      const sectionLabel = isWork ? 'Work' : 'Article';
      const card = document.createElement('div');
      card.className = 'card1';
      card.setAttribute('role', 'listitem');

      const rawTags = Array.isArray(item.tags) ? item.tags : [];
      const primaryTag = rawTags.length ? rawTags[0] : '';
      const tagSlug = primaryTag
        ? primaryTag
            .trim()
            .toLowerCase()
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, '')
        : '';
      const previewSource = item.preview_image || item.image || '';
      const hasImage = Boolean(previewSource);
      const titleHtml = htmlEscape(item.title);
      const url = htmlEscape(item.url);
      const imageSrc = hasImage ? htmlEscape(previewSource) : '';
      const safePrimaryTag = htmlEscape(primaryTag);

      const primaryTagMarkup = primaryTag
        ? `<span class="card1-category">${tagSlug ? `<a href="/tags/${tagSlug}/">${safePrimaryTag}</a>` : safePrimaryTag}</span>`
        : '';
      const ctaText = isWork ? 'SHOW WORK →' : 'READ ARTICLE →';

      card.innerHTML = `
        <a href="${url}" aria-label="${titleHtml}">
          ${hasImage
            ? `<div class="card1-top"><img src="${imageSrc}" alt="${titleHtml}"></div>`
            : `<div class="card1-top card1-top--empty"><span>${sectionLabel}</span></div>`}
        </a>
        <div class="card1-bottom">
          ${primaryTagMarkup}
          <h3><a href="${url}">${titleHtml}</a></h3>
          <a href="${url}" class="card1-cta">${ctaText}</a>
        </div>
      `;

      frag.appendChild(card);
    });
    resultsEl.appendChild(frag);
  }

  function applyFilter(items) {
    if (sectionFilter === 'all') return items;
    return items.filter(x => (x.item ? x.item.section : x.section) === sectionFilter);
  }

  function onSearch() {
    const params = new URLSearchParams(window.location.search);
    currentQuery = (params.get('q') || '').trim();

    if (!currentQuery) {
      render([]);
      return;
    }

    const found = fuse.search(currentQuery, { limit: 50 });
    render(applyFilter(found));
  }

  // Init
  fetch('{{ "/" | relURL }}index.json', { cache: 'no-store' })
    .then(r => r.json())
    .then(json => {
      data = json;
      fuse = new Fuse(json, {
        keys: [
          { name: 'title', weight: 0.6 },
          { name: 'description', weight: 0.25 },
          { name: 'tags', weight: 0.15 }
        ],
        threshold: 0.35,
        ignoreLocation: true,
      });
      onSearch();
    });

  filterRadios.forEach(r => r.addEventListener('change', (e) => {
    sectionFilter = e.target.value;
    onSearch();
  }));
})();
</script>

<style>
.header-search {
  background: color(display-p3 0.0706 0.0471 0.1608);
  color: #fff;
  margin: 0 32px 3.5rem 32px;
  border-radius: 12px;
  padding: 48px 60px;
}

.header-search .header-content {
  max-width: 680px;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.header-search .h1container {
  align-items: center;
}

.search-controls {
  display: inline-flex;
  gap: 1rem;
  align-items: center;
  flex-wrap: wrap;
  padding: 0.75rem 1rem;
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.35);
  background: rgba(12, 7, 35, 0.35);
  backdrop-filter: blur(8px);
}

.search-filters {
  display: flex;
  gap: 1rem;
  align-items: center;
  flex-wrap: wrap;
}

.search-filters label {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  font-weight: 500;
  color: rgba(255, 255, 255, 0.86);
  text-transform: uppercase;
  letter-spacing: 0.14em;
  font-size: 0.7rem;
}

.search-filters input {
  accent-color: color(display-p3 0.305 0.901 0.886);
}

.search-results-section {
  padding: 0 32px 4rem 32px;
}

.search-card-container {
  width: 100%;
  justify-content: center;
  gap: 60px 20px;
}

.card1-top--empty {
  position: relative;
  background: #F5F4FA;
}

.card1-top--empty span {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 0.35rem 0.9rem;
  border-radius: 999px;
  border: 1px dashed #CFCDE0;
  color: #7A78A1;
  font-size: 0.75rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
}

.search-empty {
  flex: 1 1 100%;
  text-align: center;
  font-size: 0.95rem;
  color: rgba(15, 9, 51, 0.55);
  padding: 3rem 1rem;
}

@media (max-width: 1100px) {
  .header-search {
    margin: 0 24px 3rem 24px;
    padding: 40px 48px;
  }

  .search-results-section {
    padding: 0 24px 3.5rem 24px;
  }
}

@media (max-width: 820px) {
  .header-search {
    margin: 0 20px 2.5rem 20px;
    padding: 36px;
  }

  .search-controls {
    width: 100%;
    justify-content: flex-start;
  }

  .search-results-section {
    padding: 0 20px 3rem 20px;
  }
}

@media (max-width: 575px) {
  .header-search {
    margin: 0 16px 2.5rem 16px;
    padding: 32px 28px;
  }

  .search-results-section {
    padding: 0 16px 2.5rem 16px;
  }
}
</style>
