{{ partial "header" . }}
<main>
  <section class="header header-about header-search">
    {{ $intro := default "Type a keyword to explore works and articles, then refine the results with filters." .Params.intro }}
    <div class="header-content">
      <div class="h1container">
        <h1 id="search-title">Show Search</h1>
        <div class="counter">
          <span class="word showinglist">showing</span>
          <div class="number total showinglist" id="search-showing" aria-label="Showing results 0 to 0">0-0</div>
        </div>
        <div class="counter">
          <span class="word">total</span>
          <div class="number total" id="search-total">0</div>
        </div>
      </div>
      <p id="search-description" class="search-lead">{{ $intro }}</p>
      <button class="header-cta-button header-cta-button-contact header-cta-button-about" onclick="document.querySelector('.card-container')?.scrollIntoView({ behavior: 'smooth' });">See What We Found ↓</button>
    </div>
    <div class="header-illustration">
      <img src="{{ "svg/header/search.svg" | relURL }}" alt="Search Illustration">
    </div>
  </section>

  <div class="container-tag-list search-filter-tags">
    <button class="tag-scroll left">←</button>
      <div class="tag-list-wrapper">
        <ul class="tag-list">
          <li>
            <label class="tag-filter tag-filter--all">
              <input type="radio" name="section" value="all" checked>
              <span class="tag-filter__body">
                <div class="tag-filter__text">
                  <span class="tag-filter__indicator"></span>All
                </div>
              </span>
            </label>
          </li>
          <li>
            <label class="tag-filter tag-filter--works">
              <input type="radio" name="section" value="works">
              <span class="tag-filter__body">
                <div class="tag-filter__text"><span class="tag-filter__indicator"></span>Works
                </div>
              </span>
            </label>
          </li>
          <li>
            <label class="tag-filter tag-filter--blog">
              <input type="radio" name="section" value="blog">
              <span class="tag-filter__body">
                <div class="tag-filter__text">Articles</div>
              </span>
            </label>
          </li>
        </ul>
      </div>
    <button class="tag-scroll right">→</button>
  </div>

  <section class="card-container">
    <div id="search-results" class="search-card-container" role="list" aria-label="Search results"></div>
  </section>

  <nav class="pagination" id="search-pagination" hidden>
    <ul class="pagination-list" id="search-pagination-list"></ul>
  </nav>
</main>

{{ partial "featured-content.html" . }}

{{ partial "cta-contact" . }}

{{ partial "footer" . }}

<!-- Fuse.js (lightweight fuzzy search) -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
(function() {
  const paramsInit = new URLSearchParams(window.location.search);
  if (!paramsInit.get('q')) {
    window.location.replace('/');
    return;
  }

  const resultsEl = document.getElementById('search-results');
  const filterRadios = document.querySelectorAll('input[name="section"]');
  const titleEl = document.getElementById('search-title');
  const descriptionEl = document.getElementById('search-description');
  const totalEl = document.getElementById('search-total');
  const showingEl = document.getElementById('search-showing');
  const paginationEl = document.getElementById('search-pagination');
  const paginationListEl = document.getElementById('search-pagination-list');
  const defaultDescription = descriptionEl ? descriptionEl.textContent.trim() : '';
  const defaultTitle = titleEl ? titleEl.textContent.trim() : 'Show Search';
  const defaultDocumentTitle = document.title;
  const siteTitleSuffix = defaultDocumentTitle.includes('|')
    ? defaultDocumentTitle.slice(defaultDocumentTitle.indexOf('|'))
    : '';
  const descriptionMetaEl = document.querySelector('meta[name="description"]');
  const defaultMetaDescription = descriptionMetaEl
    ? descriptionMetaEl.getAttribute('content') || ''
    : '';
  const PAGE_SIZE = 12;

  let fuse,
      data = [],
      sectionFilter = 'all',
      currentQuery = '',
      currentResults = [],
      currentPage = 1;

  const mergeTags = (primary, secondary) => {
    const merged = Array.isArray(primary) ? [...primary] : [];
    if (Array.isArray(secondary)) {
      secondary.forEach((tag) => {
        if (typeof tag === 'string' && !merged.includes(tag)) {
          merged.push(tag);
        }
      });
    }
    return merged;
  };

  const htmlEscape = (value) => String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  const setDescription = (html) => {
    if (!descriptionEl) {
      return;
    }
    if (html === null || html === undefined || html === '') {
      descriptionEl.textContent = defaultDescription;
    } else {
      descriptionEl.innerHTML = html;
    }
  };

  const setMetaDescription = (text) => {
    if (!descriptionMetaEl) {
      return;
    }
    const content = text && text.trim() ? text : defaultMetaDescription;
    descriptionMetaEl.setAttribute('content', content);
  };

  const hidePagination = () => {
    if (paginationEl) {
      paginationEl.setAttribute('hidden', 'hidden');
    }
    if (paginationListEl) {
      paginationListEl.innerHTML = '';
    }
  };

  const showPagination = () => {
    if (paginationEl) {
      paginationEl.removeAttribute('hidden');
    }
  };

  const updateShowingRange = (start, end, total) => {
    if (!showingEl) {
      return;
    }

    if (!total || start <= 0 || end <= 0) {
      showingEl.textContent = '0-0';
      showingEl.setAttribute('aria-label', 'Showing results 0 to 0');
      return;
    }

    showingEl.textContent = `${start}-${end}`;
    showingEl.setAttribute('aria-label', `Showing results ${start} to ${end}`);
  };

  const renderEmpty = (message) => {
    resultsEl.innerHTML = '';
    hidePagination();
    updateShowingRange(0, 0, 0);
    const empty = document.createElement('div');
    empty.className = 'search-empty';
    empty.setAttribute('role', 'status');
    empty.textContent = message;
    resultsEl.appendChild(empty);
  };

  function render(results) {
    currentResults = results;
    currentPage = 1;

    if (!currentQuery) {
      if (titleEl) {
        titleEl.textContent = defaultTitle;
      }
      setDescription(null);
      document.title = defaultDocumentTitle;
      setMetaDescription('');
      if (totalEl) {
        totalEl.textContent = '0';
        totalEl.setAttribute('aria-label', '0 results shown');
      }
      updateShowingRange(0, 0, 0);
      renderEmpty('Start your search from the navigation bar to see results here.');
      return;
    }

    const queryHtml = htmlEscape(currentQuery);

    if (titleEl) {
      titleEl.innerHTML = `Show Search <span class="search-query">"${queryHtml}"</span>`;
    }
    document.title = `Show Search "${currentQuery}"${siteTitleSuffix}`;

    if (totalEl) {
      totalEl.textContent = String(results.length);
      totalEl.setAttribute('aria-label', `${results.length} result${results.length === 1 ? '' : 's'} shown`);
    }

    if (!results.length) {
      setDescription(`We couldn't find any matches for <span class="search-query">"${queryHtml}"</span>. Try a different keyword or adjust the filters.`);
      setMetaDescription(`No matches for "${currentQuery}" on Rausr. Try another keyword or adjust the filters.`);
      renderEmpty(`No results for "${currentQuery}"`);
      return;
    }

    setDescription(`Exploring <span class="search-query">"${queryHtml}"</span> across works and articles. Use the filters to focus on what you need.`);
    setMetaDescription(`Viewing ${results.length} result${results.length === 1 ? '' : 's'} for "${currentQuery}" across Rausr.`);
    renderPage(1);
  }

  function renderPage(pageNumber) {
    const total = currentResults.length;
    if (!total) {
      renderEmpty(`No results for "${currentQuery}"`);
      return;
    }

    const totalPages = Math.ceil(total / PAGE_SIZE);
    const safeTotalPages = Math.max(totalPages, 1);
    const targetPage = Math.min(Math.max(pageNumber, 1), safeTotalPages);
    currentPage = targetPage;

    const startIndex = (targetPage - 1) * PAGE_SIZE;
    const pageSlice = currentResults.slice(startIndex, startIndex + PAGE_SIZE);
    const pageStart = pageSlice.length ? startIndex + 1 : 0;
    const pageEnd = pageSlice.length ? startIndex + pageSlice.length : 0;

    const frag = document.createDocumentFragment();
    pageSlice.forEach((entry) => {
      const item = entry.item || entry; // Fuse returns {item, score}; fallback if not searched yet
      const isWork = item.section === 'works';
      const sectionLabel = isWork ? 'Work' : 'Article';
      const card = document.createElement('div');
      const cardVariant = isWork ? 'card1--works' : 'card1--blog';
      card.className = `card1 ${cardVariant}`;
      card.setAttribute('role', 'listitem');

      const rawTags = mergeTags(item.tags, item.seotags);
      const primaryTag = rawTags.length ? rawTags[0] : '';
      const tagSlug = primaryTag
        ? primaryTag
            .trim()
            .toLowerCase()
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, '')
        : '';
      const previewSource = item.preview_image || item.image || '';
      const hasImage = Boolean(previewSource);
      const titleHtml = htmlEscape(item.title);
      const url = htmlEscape(item.url);
      const imageSrc = hasImage ? htmlEscape(previewSource) : '';
      const safePrimaryTag = htmlEscape(primaryTag);

      const primaryTagMarkup = primaryTag
        ? `<span class="card1-category">${tagSlug ? `<a href="/tags/${tagSlug}/">${safePrimaryTag}</a>` : safePrimaryTag}</span>`
        : '';
      const ctaText = isWork ? 'SHOW WORK →' : 'READ ARTICLE →';

      card.innerHTML = `
        <a href="${url}" aria-label="${titleHtml}">
          ${hasImage
            ? `<div class="card1-top"><img src="${imageSrc}" alt="${titleHtml}"></div>`
            : `<div class="card1-top card1-top--empty"><span>${sectionLabel}</span></div>`}
        </a>
        <div class="card1-bottom">
          ${primaryTagMarkup}
          <h3><a href="${url}">${titleHtml}</a></h3>
          <a href="${url}" class="card1-cta">${ctaText}</a>
        </div>
      `;

      frag.appendChild(card);
    });

    resultsEl.innerHTML = '';
    resultsEl.appendChild(frag);

    updateShowingRange(pageStart, pageEnd, total);
    updatePaginationControls(safeTotalPages);
  }

  function updatePaginationControls(totalPages) {
    if (!paginationEl || !paginationListEl) {
      return;
    }

    if (!totalPages || totalPages <= 1) {
      hidePagination();
      return;
    }

    paginationListEl.innerHTML = '';
    showPagination();

    const scrollToResultsTop = () => {
      resultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    const addButton = (label, targetPage, { disabled = false, active = false, ariaLabel = '' } = {}) => {
      const item = document.createElement('li');
      item.className = 'pagination-item';
      if (disabled) {
        item.classList.add('disabled');
      }

      const element = document.createElement(disabled ? 'span' : 'a');
      element.className = 'pagination-link';
      element.textContent = label;
      if (ariaLabel) {
        element.setAttribute('aria-label', ariaLabel);
      }

      if (disabled) {
        element.setAttribute('aria-disabled', 'true');
      } else {
        element.href = '#search-results';
        element.addEventListener('click', (event) => {
          event.preventDefault();
          if (targetPage === currentPage) {
            return;
          }
          renderPage(targetPage);
          scrollToResultsTop();
        });
      }

      if (active) {
        element.classList.add('active');
        element.setAttribute('aria-current', 'page');
      }

      item.appendChild(element);
      paginationListEl.appendChild(item);
    };

    const addEllipsis = () => {
      addButton('...', currentPage, { disabled: true });
    };

    addButton('←', currentPage - 1, {
      disabled: currentPage === 1,
      ariaLabel: 'Previous page',
    });

    const pagesToShow = new Set([1, totalPages]);
    for (let i = currentPage - 1; i <= currentPage + 1; i += 1) {
      if (i > 1 && i < totalPages) {
        pagesToShow.add(i);
      }
    }

    const orderedPages = Array.from(pagesToShow).sort((a, b) => a - b);
    let lastPageRendered = 0;
    orderedPages.forEach((page) => {
      if (page - lastPageRendered > 1) {
        addEllipsis();
      }

      addButton(String(page), page, {
        active: page === currentPage,
        ariaLabel: `Page ${page}`,
      });

      lastPageRendered = page;
    });

    addButton('→', currentPage + 1, {
      disabled: currentPage === totalPages,
      ariaLabel: 'Next page',
    });
  }

  function applyFilter(items) {
    if (sectionFilter === 'all') return items;
    return items.filter(x => (x.item ? x.item.section : x.section) === sectionFilter);
  }

  function onSearch() {
    const params = new URLSearchParams(window.location.search);
    currentQuery = (params.get('q') || '').trim();

    if (!currentQuery) {
      render([]);
      return;
    }

    const found = fuse.search(currentQuery);
    render(applyFilter(found));
  }

  // Init
  fetch('{{ "/" | relURL }}index.json', { cache: 'no-store' })
    .then(r => r.json())
    .then(json => {
      data = json;
      fuse = new Fuse(json, {
        keys: [
          { name: 'title', weight: 0.6 },
          { name: 'description', weight: 0.25 },
          { name: 'tags', weight: 0.15 },
          { name: 'seotags', weight: 0.1 }
        ],
        threshold: 0.35,
        ignoreLocation: true,
      });
      onSearch();
    });

  filterRadios.forEach(r => r.addEventListener('change', (e) => {
    sectionFilter = e.target.value;
    onSearch();
  }));
})();
</script>

<style>
.header-search {
  background-color: color(display-p3 0.4078 0.2824 1);
  color: color(display-p3 0.831 1.000 0.807);
}

.header-search p {
  color: color(display-p3 0.831 1.000 0.807);
}

.search-lead {
  margin: 0;
  font-size: 1rem;
  color: color(display-p3 0.831 1.000 0.807);
  line-height: 1.5;
}

.search-query {
  color: #ffffff;
}


.tag-filter {
  position: relative;
  display: inline-block;
  font-family: 'Inter', sans-serif;
  font-weight: 500;
  letter-spacing: 0.01em;
  cursor: pointer;
}

.tag-filter input {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}


.tag-filter__body {
  --filter-border: rgba(180, 176, 202, 0.75);
  --filter-color: rgba(111, 106, 134, 0.9);
  --filter-bg: #ffffff;
  --filter-border-active: rgba(111, 106, 134, 0.95);
  --filter-bg-active: rgba(230, 228, 245, 0.55);
  display: inline-flex;
  align-items: center;
  background: var(--filter-bg);
  color: var(--filter-color);
  transition: all 0.2s ease;
}



.tag-filter__indicator {
  background: radial-gradient(circle, transparent 45%, transparent 48%, currentColor 48%, currentColor 100%);
  transition: all 0.2s ease;
}

.tag-filter__text {
  pointer-events: none;
}

.tag-filter input:checked + .tag-filter__body,
.tag-filter:hover .tag-filter__body {
  border-color: var(--filter-border-active);
  background: var(--filter-bg-active);
  color: var(--filter-border-active);
}

.tag-filter input:checked + .tag-filter__body .tag-filter__indicator,
.tag-filter:hover .tag-filter__body .tag-filter__indicator {
  background: radial-gradient(circle, currentColor 0%, currentColor 45%, transparent 48%, transparent 100%);
}

.tag-filter--works .tag-filter__body {
  --filter-border: color(display-p3 0.129 0.561 1.000);
  --filter-color: color(display-p3 0.129 0.561 1.000);
  --filter-border-active: color(display-p3 0.129 0.561 1.000);
  --filter-bg-active: color(display-p3 0.305 0.901 0.886 / 0.28);
}

.tag-filter--blog .tag-filter__body {
  --filter-border: color(display-p3 0.055 0.604 0.447);
  --filter-color: color(display-p3 0.055 0.604 0.447);
  --filter-border-active: color(display-p3 0.055 0.604 0.447);
  --filter-bg-active: color(display-p3 0.055 0.604 0.447 / 0.20);
}

.tag-filter--all .tag-filter__body {
  --filter-border: rgba(180, 176, 202, 0.75);
  --filter-color: rgba(111, 106, 134, 0.9);
  --filter-border-active: rgba(111, 106, 134, 0.95);
  --filter-bg-active: rgba(230, 228, 245, 0.55);
}


.search-card-container {
  display: flex;
  flex-wrap: wrap;
  width: 100%;
  justify-content: center;
  gap: 60px 20px;
}

.card1-top--empty {
  position: relative;
  background: #F5F4FA;
}

.card1-top--empty span {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 0.35rem 0.9rem;
  border-radius: 999px;
  border: 1px dashed #CFCDE0;
  color: #7A78A1;
  font-size: 0.75rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
}

.search-empty {
  flex: 1 1 100%;
  text-align: center;
  font-size: 0.95rem;
  color: rgba(15, 9, 51, 0.55);
  padding: 3rem 1rem;
}

.card1--works .card1-bottom {
  background: color(display-p3 0.129 0.561 1.000);
}

.card1--blog .card1-bottom {
  background: color(display-p3 0.055 0.604 0.447);
}

.card1--works .card1-cta,
.card1--blog .card1-cta {
  color: color(display-p3 0.964 1.000 0.247) !important;
}

.card1--blog .card1-cta:hover,
.card1--works .card1-cta:hover {
  color: #fff !important;
}

@media (max-width: 1100px) {

  .search-filter-tags {
    margin: 1rem auto 2rem auto;
    padding: 1rem;
  }

@media (max-width: 820px) {

  .search-filter-tags {
    margin: 0 20px 2.5rem 20px;
  }
}

@media (max-width: 575px) {

  .search-filter-tags {
    margin: 1rem auto 2rem auto;
    padding: 1rem;
  }

  .search-card-container {
    gap: 3rem 0.75rem;
  }

}
</style>
