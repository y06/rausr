{{ partial "header" . }}
<main>
  <section class="header header-about header-search">
    <div class="header-content">
      <div class="h1container">
        <h1 id="search-title">Search</h1>
        <div class="counter">
          <span class="word">total</span>
          <div class="number total" id="search-total">0</div>
        </div>
      </div>
      <p>Select from the search results and filter by the type of content you want.</p>
      <button class="header-cta-button header-cta-button-contact header-cta-button-about" onclick="document.querySelector('.card-container')?.scrollIntoView({ behavior: 'smooth' });">See What We Found ↓</button>
    </div>
    <div class="header-illustration">
      <img src="{{ "svg/header/search.svg" | relURL }}" alt="Search Illustration">
    </div>
  </section>

  <div class="container-tag-list search-filter-tags">
    <button class="tag-scroll left">←</button>
      <div class="tag-list-wrapper">
        <ul class="tag-list">
          <li>
            <label class="tag-filter tag-filter--all">
              <input type="radio" name="section" value="all" checked>
              <span class="tag-filter__body">
                <div class="tag-filter__text">
                  <span class="tag-filter__indicator"></span>All
                </div>
              </span>
            </label>
          </li>
          <li>
            <label class="tag-filter tag-filter--works">
              <input type="radio" name="section" value="works">
              <span class="tag-filter__body">
                <div class="tag-filter__text"><span class="tag-filter__indicator"></span>Works
                </div>
              </span>
            </label>
          </li>
          <li>
            <label class="tag-filter tag-filter--blog">
              <input type="radio" name="section" value="blog">
              <span class="tag-filter__body">
                <div class="tag-filter__text">Articles</div>
              </span>
            </label>
          </li>
        </ul>
      </div>
    <button class="tag-scroll right">→</button>
  </div>

  <section class="card-container">
    <div id="search-results" class="card-container search-card-container" role="list" aria-label="Search results"></div>
  </section>
</main>

{{ partial "featured-content.html" . }}

{{ partial "cta-contact" . }}

{{ partial "footer" . }}

<!-- Fuse.js (lightweight fuzzy search) -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
(function() {
  const paramsInit = new URLSearchParams(window.location.search);
  if (!paramsInit.get('q')) {
    window.location.replace('/');
    return;
  }

  const resultsEl = document.getElementById('search-results');
  const filterRadios = document.querySelectorAll('input[name="section"]');
  const titleEl = document.getElementById('search-title');
  const totalEl = document.getElementById('search-total');

  let fuse, data = [], sectionFilter = 'all', currentQuery = '';

  const htmlEscape = (value) => String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  function render(results) {
    resultsEl.innerHTML = '';
    const showMessage = (message) => {
      const empty = document.createElement('div');
      empty.className = 'search-empty';
      empty.setAttribute('role', 'status');
      empty.textContent = message;
      resultsEl.appendChild(empty);
    };
    if (!currentQuery) {
      if (titleEl) titleEl.textContent = 'Search';
      if (totalEl) {
        totalEl.textContent = '0';
        totalEl.setAttribute('aria-label', '0 results shown');
      }
      showMessage('Start your search from the navigation bar to see results here.');
      return;
    }
    if (titleEl) {
      const queryHtml = htmlEscape(currentQuery);
      titleEl.innerHTML = `Search results for: <span class="search-query">${queryHtml}</span>`;
    }
    if (totalEl) {
      totalEl.textContent = String(results.length);
      totalEl.setAttribute('aria-label', `${results.length} result${results.length===1?'':'s'} shown`);
    }
    if (!results.length) {
      showMessage(`No results for "${currentQuery}"`);
      return;
    }
    const frag = document.createDocumentFragment();
    results.forEach(r => {
      const item = r.item || r; // Fuse returns {item, score}; fallback if not searched yet
      const isWork = item.section === 'works';
      const sectionLabel = isWork ? 'Work' : 'Article';
      const card = document.createElement('div');
      const cardVariant = isWork ? 'card1--works' : 'card1--blog';
      card.className = `card1 ${cardVariant}`;
      card.setAttribute('role', 'listitem');

      const rawTags = Array.isArray(item.tags) ? item.tags : [];
      const primaryTag = rawTags.length ? rawTags[0] : '';
      const tagSlug = primaryTag
        ? primaryTag
            .trim()
            .toLowerCase()
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, '')
        : '';
      const previewSource = item.preview_image || item.image || '';
      const hasImage = Boolean(previewSource);
      const titleHtml = htmlEscape(item.title);
      const url = htmlEscape(item.url);
      const imageSrc = hasImage ? htmlEscape(previewSource) : '';
      const safePrimaryTag = htmlEscape(primaryTag);

      const primaryTagMarkup = primaryTag
        ? `<span class="card1-category">${tagSlug ? `<a href="/tags/${tagSlug}/">${safePrimaryTag}</a>` : safePrimaryTag}</span>`
        : '';
      const ctaText = isWork ? 'SHOW WORK →' : 'READ ARTICLE →';

      card.innerHTML = `
        <a href="${url}" aria-label="${titleHtml}">
          ${hasImage
            ? `<div class="card1-top"><img src="${imageSrc}" alt="${titleHtml}"></div>`
            : `<div class="card1-top card1-top--empty"><span>${sectionLabel}</span></div>`}
        </a>
        <div class="card1-bottom">
          ${primaryTagMarkup}
          <h3><a href="${url}">${titleHtml}</a></h3>
          <a href="${url}" class="card1-cta">${ctaText}</a>
        </div>
      `;

      frag.appendChild(card);
    });
    resultsEl.appendChild(frag);
  }

  function applyFilter(items) {
    if (sectionFilter === 'all') return items;
    return items.filter(x => (x.item ? x.item.section : x.section) === sectionFilter);
  }

  function onSearch() {
    const params = new URLSearchParams(window.location.search);
    currentQuery = (params.get('q') || '').trim();

    if (!currentQuery) {
      render([]);
      return;
    }

    const found = fuse.search(currentQuery, { limit: 50 });
    render(applyFilter(found));
  }

  // Init
  fetch('{{ "/" | relURL }}index.json', { cache: 'no-store' })
    .then(r => r.json())
    .then(json => {
      data = json;
      fuse = new Fuse(json, {
        keys: [
          { name: 'title', weight: 0.6 },
          { name: 'description', weight: 0.25 },
          { name: 'tags', weight: 0.15 }
        ],
        threshold: 0.35,
        ignoreLocation: true,
      });
      onSearch();
    });

  filterRadios.forEach(r => r.addEventListener('change', (e) => {
    sectionFilter = e.target.value;
    onSearch();
  }));
})();
</script>

<style>
.header-search {
  background-color: color(display-p3 0.4078 0.2824 1);
  color: color(display-p3 0.831 1.000 0.807);
}

.header-search p {
  color: color(display-p3 0.831 1.000 0.807);
}

.search-lead {
  margin: 0;
  font-size: 1rem;
  color: color(display-p3 0.831 1.000 0.807);
  line-height: 1.5;
}

.search-query {
  color: #ffffff;
}


.tag-filter {
  position: relative;
  display: inline-block;
  font-family: 'Inter', sans-serif;
  font-weight: 500;
  letter-spacing: 0.01em;
  cursor: pointer;
}

.tag-filter input {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}


.tag-filter__body {
  --filter-border: rgba(180, 176, 202, 0.75);
  --filter-color: rgba(111, 106, 134, 0.9);
  --filter-bg: #ffffff;
  --filter-border-active: rgba(111, 106, 134, 0.95);
  --filter-bg-active: rgba(230, 228, 245, 0.55);
  display: inline-flex;
  align-items: center;
  background: var(--filter-bg);
  color: var(--filter-color);
  transition: all 0.2s ease;
}



.tag-filter__indicator {
  background: radial-gradient(circle, transparent 45%, transparent 48%, currentColor 48%, currentColor 100%);
  transition: all 0.2s ease;
}

.tag-filter__text {
  pointer-events: none;
}

.tag-filter input:checked + .tag-filter__body,
.tag-filter:hover .tag-filter__body {
  border-color: var(--filter-border-active);
  background: var(--filter-bg-active);
  color: var(--filter-border-active);
}

.tag-filter input:checked + .tag-filter__body .tag-filter__indicator,
.tag-filter:hover .tag-filter__body .tag-filter__indicator {
  background: radial-gradient(circle, currentColor 0%, currentColor 45%, transparent 48%, transparent 100%);
}

.tag-filter--works .tag-filter__body {
  --filter-border: color(display-p3 0.129 0.561 1.000);
  --filter-color: color(display-p3 0.129 0.561 1.000);
  --filter-border-active: color(display-p3 0.129 0.561 1.000);
  --filter-bg-active: color(display-p3 0.305 0.901 0.886 / 0.28);
}

.tag-filter--blog .tag-filter__body {
  --filter-border: color(display-p3 0.055 0.604 0.447);
  --filter-color: color(display-p3 0.055 0.604 0.447);
  --filter-border-active: color(display-p3 0.055 0.604 0.447);
  --filter-bg-active: color(display-p3 0.055 0.604 0.447 / 0.20);
}

.tag-filter--all .tag-filter__body {
  --filter-border: rgba(180, 176, 202, 0.75);
  --filter-color: rgba(111, 106, 134, 0.9);
  --filter-border-active: rgba(111, 106, 134, 0.95);
  --filter-bg-active: rgba(230, 228, 245, 0.55);
}


.search-card-container {
  width: 100%;
  justify-content: center;
  gap: 60px 20px;
}

.card1-top--empty {
  position: relative;
  background: #F5F4FA;
}

.card1-top--empty span {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 0.35rem 0.9rem;
  border-radius: 999px;
  border: 1px dashed #CFCDE0;
  color: #7A78A1;
  font-size: 0.75rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
}

.search-empty {
  flex: 1 1 100%;
  text-align: center;
  font-size: 0.95rem;
  color: rgba(15, 9, 51, 0.55);
  padding: 3rem 1rem;
}

.card1--works .card1-bottom {
  background: color(display-p3 0.129 0.561 1.000);
}

.card1--blog .card1-bottom {
  background: color(display-p3 0.055 0.604 0.447);
}

.card1--works .card1-cta,
.card1--blog .card1-cta {
  color: color(display-p3 0.964 1.000 0.247) !important;
}

.card1--blog .card1-cta:hover,
.card1--works .card1-cta:hover {
  color: #fff !important;
}

@media (max-width: 1100px) {

  .search-filter-tags {
    margin: 0 24px 2.75rem 24px;
  }

@media (max-width: 820px) {

  .search-filter-tags {
    margin: 0 20px 2.5rem 20px;
  }
}

@media (max-width: 575px) {

  .search-filter-tags {
    margin: 0 16px 2.2rem 16px;
  }

}
</style>
