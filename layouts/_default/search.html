{{ partial "header" . }}
<main>
  <section class="search-section container">
    <h1>Search</h1>

    <div class="search-controls">
      <input id="search-input" type="search" placeholder="Search works & articles…" autocomplete="off" />
      <div class="search-filters">
        <label><input type="radio" name="section" value="all" checked> All</label>
        <label><input type="radio" name="section" value="works"> Works</label>
        <label><input type="radio" name="section" value="blog"> Articles</label>
      </div>
    </div>

    <div id="search-stats" class="search-stats" aria-live="polite"></div>
    <div id="search-results" class="search-results featured-grid" role="list" aria-label="Search results"></div>
  </section>
</main>

{{ partial "featured-content.html" . }}

{{ partial "cta-contact" . }}

{{ partial "footer" . }}

<!-- Fuse.js (lightweight fuzzy search) -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
(function() {
  const input = document.getElementById('search-input');
  const resultsEl = document.getElementById('search-results');
  const statsEl = document.getElementById('search-stats');
  const filterRadios = document.querySelectorAll('input[name="section"]');

  let fuse, data = [], sectionFilter = 'all';

  const htmlEscape = (value) => String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  function render(results) {
    resultsEl.innerHTML = '';
    if (!results.length) {
      statsEl.textContent = 'No results';
      return;
    }
    statsEl.textContent = results.length + ' result' + (results.length===1?'':'s');
    const frag = document.createDocumentFragment();
    results.forEach(r => {
      const item = r.item || r; // Fuse returns {item, score}; fallback if not searched yet
      const isWork = item.section === 'works';
      const sectionLabel = isWork ? 'Work' : 'Article';
      const cardType = isWork ? 'works' : 'blog';
      const card = document.createElement('div');
      card.className = `card1 card1--search card1--search-${cardType}`;
      card.setAttribute('role', 'listitem');

      const rawTags = Array.isArray(item.tags) ? item.tags : [];
      const primaryTag = rawTags.length ? rawTags[0] : '';
      const tagSlug = primaryTag
        ? primaryTag
            .trim()
            .toLowerCase()
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, '')
        : '';
      const hasImage = Boolean(item.image);
      const titleHtml = htmlEscape(item.title);
      const descriptionHtml = item.description ? htmlEscape(item.description) : '';
      const url = htmlEscape(item.url);
      const imageSrc = hasImage ? htmlEscape(item.image) : '';
      const safePrimaryTag = htmlEscape(primaryTag);

      const allTagsMarkup = rawTags.length
        ? `<div class="card-search-tags">${rawTags.map(t => `<span class="card-search-tag">${htmlEscape(t)}</span>`).join('')}</div>`
        : '';

      card.innerHTML = `
        <a href="${url}" class="card-search-link" aria-label="${titleHtml}">
          <div class="card1-top${hasImage ? '' : ' card1-top--empty'}">
            ${hasImage ? `<img src="${imageSrc}" alt="">` : `<span>${sectionLabel}</span>`}
          </div>
        </a>
        <div class="card1-bottom card-search-bottom card-search-bottom--${cardType}">
          <div class="card-search-eyebrow">
            <span class="card-search-section">${sectionLabel}</span>
            ${primaryTag ? `<span class="card1-category">${tagSlug ? `<a href="/tags/${tagSlug}/">${safePrimaryTag}</a>` : safePrimaryTag}</span>` : ''}
          </div>
          <h3><a href="${url}">${titleHtml}</a></h3>
          ${descriptionHtml ? `<p class="card-search-desc">${descriptionHtml}</p>` : ''}
          ${allTagsMarkup}
        </div>
        <a href="${url}" class="card2-cta card2-cta--${cardType}">${isWork ? 'show work →' : 'read article →'}</a>
      `;

      frag.appendChild(card);
    });
    resultsEl.appendChild(frag);
  }

  function applyFilter(items) {
    if (sectionFilter === 'all') return items;
    return items.filter(x => (x.item ? x.item.section : x.section) === sectionFilter);
  }

  function onSearch() {
    const q = input.value.trim();
    if (!q) {
      render(applyFilter(data));
      return;
    }
    const found = fuse.search(q, { limit: 50 });
    render(applyFilter(found));
  }

  // Init
  fetch('{{ "/" | relURL }}index.json', { cache: 'no-store' })
    .then(r => r.json())
    .then(json => {
      data = json;
      fuse = new Fuse(json, {
        keys: [
          { name: 'title', weight: 0.6 },
          { name: 'description', weight: 0.25 },
          { name: 'tags', weight: 0.15 }
        ],
        threshold: 0.35,
        ignoreLocation: true,
      });
      const params = new URLSearchParams(window.location.search);
      const presetQuery = params.get('q');
      if (presetQuery) {
        input.value = presetQuery;
        onSearch();
      } else {
        render(data); // initial list
      }
    });

  input.addEventListener('input', onSearch);
  filterRadios.forEach(r => r.addEventListener('change', (e) => {
    sectionFilter = e.target.value;
    onSearch();
  }));
})();
</script>

<style>
.search-controls { display: grid; gap: 0.75rem; margin-bottom: 1rem; }
#search-input { padding: .75rem 1rem; border-radius: 12px; width: 100%; border: 1px solid #E5E4EC; background: #fff; color: inherit; }
.search-filters { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
.search-filters input { accent-color: color(display-p3 0.305 0.901 0.886); }
.search-stats { margin:.25rem 0 1.5rem; font-size:.9rem; opacity:.7; }

.search-results { width: 100%; margin: 0 auto 3rem; padding: 0; display: flex; flex-wrap: wrap; gap: 20px; justify-content: flex-start; }
.card1--search { display: flex; flex-direction: column; border-radius: 12px; overflow: hidden; background: #fff; width: clamp(260px, 45vw, 320px) !important; flex: 1 1 clamp(260px, 45vw, 320px); }
.card1--search .card1-top { background: #F5F4FA; }
.card1-top--empty { display: flex; align-items: center; justify-content: center; color: #9A96B5; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.12em; }
.card1-top--empty span { padding: 0.35rem 0.9rem; border-radius: 999px; border: 1px dashed #CFCDE0; }
.card-search-link { display: block; text-decoration: none; color: inherit; }

.card-search-bottom { display: flex; flex-direction: column; gap: 0.75rem; text-align: left; }
.card-search-eyebrow { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
.card-search-section { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.12em; color: rgba(255, 255, 255, 0.72); }
.card1--search .card1-bottom h3 a { color: inherit; text-decoration: none; }
.card-search-desc { margin: 0; font-size: 0.9rem; line-height: 1.45; color: rgba(255, 255, 255, 0.9); }
.card-search-tags { display: flex; flex-wrap: wrap; gap: 0.4rem; }
.card-search-tag { font-size: 0.7rem; padding: 0.25rem 0.6rem; border-radius: 999px; background: rgba(255, 255, 255, 0.16); border: 1px solid rgba(255, 255, 255, 0.28); color: rgba(255, 255, 255, 0.85); }

.card1--search-works .card1-bottom { background: color(display-p3 0.129 0.561 1.000); }
.card1--search-blog .card1-bottom { background: color(display-p3 0.055 0.604 0.447); }

.card2-cta--works { color: color(display-p3 0.129 0.561 1.000) !important; }
.card2-cta--blog { color: color(display-p3 0.055 0.604 0.447) !important; }

@media (max-width: 1024px) {
  .card1--search { flex: 1 1 clamp(280px, 50vw, 320px); }
}

@media (max-width: 768px) {
  .search-results { justify-content: center; }
  .card1--search { flex: 1 1 calc(50% - 20px); width: calc(50% - 20px) !important; max-width: 360px; }
}

@media (max-width: 575px) {
  .card1--search { flex: 1 1 100%; width: 100% !important; max-width: 100%; }
}
</style>
